(function () {
    'use strict';

    // 全局变量
    let countdownTimer = null;
    let statusCheckTimer = null;
    let totalSeconds = null;
    let paymentConfig = {};

    // 初始化配置
    function initConfig(config) {
        paymentConfig = config;
        totalSeconds = config.expire;
    }

    // 生成二维码
    function generateQRCode() {
        const qrContainer = document.getElementById('qrcode');
        const containerWidth = qrContainer.offsetWidth;
        const qrSize = Math.min(containerWidth - 10, 150); // 留出10px的边距

        $('#qrcode').qrcode({
            text: paymentConfig.address,
            width: qrSize,
            height: qrSize,
            foreground: "#000000",
            background: "#ffffff",
            typeNumber: -1
        });
    }

    // 复制地址
    function copyAddress() {
        const address = document.getElementById('walletAddress').textContent;
        navigator.clipboard.writeText(address).then(function () {
            const btn = document.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = '已复制!';
            btn.style.background = '#48bb78';

            setTimeout(function () {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 2000);
        }).catch(function (err) {
            console.error('复制失败: ', err);
            // 降级方案
            const textArea = document.createElement('textarea');
            textArea.value = address;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '已复制!';
                btn.style.background = '#48bb78';
                setTimeout(function () {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            } catch (err) {
                alert('复制失败，请手动复制地址');
            }
            document.body.removeChild(textArea);
        });
    }

    // 倒计时
    function startCountdown() {
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');

        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            if (totalSeconds <= 0) {
                minutesEl.textContent = '00';
                secondsEl.textContent = '00';
            } else {
                minutesEl.textContent = minutes.toString().padStart(2, '0');
                secondsEl.textContent = seconds.toString().padStart(2, '0');
            }

            // 当剩余时间少于5分钟时，倒计时变红色
            if (totalSeconds <= 300) { // 5分钟 = 300秒
                document.querySelector('.countdown-banner').style.background = 'linear-gradient(135deg, #ff4757, #ff3838)';
            }

            // 当剩余时间少于1分钟时，添加紧急闪烁效果
            if (totalSeconds <= 60) {
                document.querySelector('.countdown-banner').style.animation = 'urgentBlink 1s infinite';
            }
        }

        countdownTimer = setInterval(function () {
            totalSeconds--;
            updateDisplay();

            if (totalSeconds <= 0) {
                clearInterval(countdownTimer);
                clearInterval(statusCheckTimer);
                showTimeoutMessage();
            }
        }, 1000);

        // 初始化显示
        updateDisplay();
    }

    // 支付超时
    function showTimeoutMessage() {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        `;

        modal.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 20px;">⏰</div>
            <h3 style="color: #e53e3e; margin-bottom: 15px;">支付时间已过期</h3>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
                很抱歉，支付时间已超时。<br>
                请重新发起支付或联系客服处理。
            </p>
            <button onclick="location.href='${paymentConfig.return_url}'" style="
                background: #667eea;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                margin-right: 10px;
            ">返回商户平台</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }

    // 等待网络确认
    function showWaitingConfirmation(data) {
        // 如果弹窗已存在，不重复创建
        if (document.getElementById('waiting-overlay')) {
            return;
        }

        const overlay = document.createElement('div');
        overlay.id = 'waiting-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        `;

        modal.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 20px; animation: spin 2s linear infinite;">⏳</div>
            <h3 style="color: #667eea; margin-bottom: 15px;">正在等待网络确认</h3>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                <span style="color: #059669; font-weight: 600; background: linear-gradient(135deg, #ecfdf5, #f0fdf4); padding: 8px 12px; border-radius: 6px; border-left: 3px solid #10b981;">检测到付款请求，区块网络确认中...</span><br>
                <small style="color: #999;">请耐心等待，系统会自动检测确认状态</small>
            </p>
            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <div style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            <p style="color: #999; font-size: 12px;">
                预计确认时间：1-3分钟
            </p>
        `;

        // 添加旋转动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // 继续检查支付状态
        statusCheckTimer = setInterval(checkPaymentStatus, 5000);
    }

    // 支付成功
    function showSuccessMessage(data) {
        // 移除等待确认弹窗
        const waitingOverlay = document.getElementById('waiting-overlay');
        if (waitingOverlay) {
            waitingOverlay.remove();
        }

        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        `;

        modal.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
            <h3 style="color: #48bb78; margin-bottom: 15px;">支付成功！</h3>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                您的支付已确认，交易哈希：<br>
                <code style="background: #e6f0fa; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-size: 12px; word-break: break-all;">
                    ${data.trade_hash || '处理中...'}
                </code>
            </p>
            <button onclick="location.href='${data.return_url || '/'}'" style="
                background: #48bb78;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">返回商户平台</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // 清除定时器
        if (countdownTimer) clearInterval(countdownTimer);
        if (statusCheckTimer) clearInterval(statusCheckTimer);
    }

    // 检查支付状态
    function checkPaymentStatus() {
        $.ajax({
            type: "GET",
            dataType: "json",
            url: "/pay/check-status/" + paymentConfig.trade_id,
            success: function (data) {
                if (data.status === 1) {
                    return setTimeout(checkPaymentStatus, 5000);  // 等待支付
                }
                if (data.status === 2) {
                    return showSuccessMessage(data);  // 支付成功
                }
                if (data.status === 3) {
                    return showTimeoutMessage(); // 支付超时
                }
                if (data.status === 5) {
                    return showWaitingConfirmation(data); // 等待网络确认
                }
            }
        });
    }

    // 初始化函数
    function init(config) {
        initConfig(config);
        generateQRCode();
        startCountdown();
        setTimeout(checkPaymentStatus, 2000);
    }

    // 暴露全局函数
    window.copyAddress = copyAddress;
    window.Payment = {
        init: init
    };

})();